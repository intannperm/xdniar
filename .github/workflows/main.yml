name: Ubuntu + ngrok SSH

on:
  workflow_dispatch: {}

jobs:
  ssh:
    runs-on: ubuntu-latest
    timeout-minutes: 360   # max runtime GitHub runner = 6 jam

    steps:
      - name: Info OS
        run: |
          uname -a
          cat /etc/os-release

      - name: Setup SSH authorized_keys
        shell: bash
        env:
          SSH_PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }}
        run: |
          set -euxo pipefail
          install -d -m 700 "$HOME/.ssh"
          echo "$SSH_PUBLIC_KEY" >> "$HOME/.ssh/authorized_keys"
          chmod 600 "$HOME/.ssh/authorized_keys"
          ls -la "$HOME/.ssh"

      - name: Install ngrok
        run: |
          curl -s https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz | tar zx
          sudo mv ngrok /usr/local/bin/

      - name: Auth ngrok
        env:
          NGROK_AUTHTOKEN: ${{ secrets.NGROK_AUTHTOKEN }}
        run: |
          ngrok config add-authtoken "$NGROK_AUTHTOKEN"

      - name: Start ngrok TCP 22 (SSH)
        run: |
          nohup ngrok tcp 22 --log=stdout > ngrok.log 2>&1 &
          sleep 5
          echo "=== NGROK STATUS ==="
          curl --silent --show-error http://127.0.0.1:4040/api/tunnels | jq .

      - name: Keep alive
        run: |
          echo "Runner aktif. Tunggu sampai 6 jam max."
          while true; do sleep 300; done
